# Root-level Dockerfile building the app from the sylius/ subdirectory
FROM php:8.2-apache

# Install required PHP extensions and tools
RUN apt-get update && apt-get install -y --no-install-recommends \
    libzip-dev \
    libicu-dev \
    libxml2-dev \
    libfreetype6-dev \
    libjpeg62-turbo-dev \
    libpng-dev \
    libsqlite3-dev \
    sqlite3 \
    libonig-dev \
    pkg-config \
    zip \
    unzip \
    git \
    curl \
    ca-certificates \
    && docker-php-ext-configure gd --with-freetype --with-jpeg \
    && export PKG_CONFIG_PATH=/usr/lib/x86_64-linux-gnu/pkgconfig:$PKG_CONFIG_PATH \
    && docker-php-ext-configure pdo_sqlite --with-pdo-sqlite=/usr \
    && docker-php-ext-install -j$(nproc) zip pdo pdo_sqlite intl xml gd mbstring opcache \
    && apt-get clean \
    && rm -rf /var/lib/apt/lists/*
# Enable Apache mod_rewrite
RUN a2enmod rewrite

# Set working directory
WORKDIR /var/www/html

# Install Composer (must be BEFORE any 'composer' commands)
RUN curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer

# Copy composer file for caching
COPY composer.json ./

# Install deps (allow scripts for Symfony Runtime)
ENV COMPOSER_ALLOW_SUPERUSER=1
# Install without scripts first to avoid symfony-cmd issues
RUN composer install --no-dev --optimize-autoloader --no-scripts --no-interaction --prefer-dist --ignore-platform-reqs
# Generate autoload_runtime.php manually if it doesn't exist (Symfony Runtime requirement)
# This file is normally generated by symfony/runtime composer scripts
# Note: We'll load index.php.original (created later) to avoid circular reference
RUN cat > vendor/autoload_runtime.php << 'EOF'
<?php

// Ensure autoloader is loaded before anything else
require_once __DIR__."/autoload.php";

return function (array $context = []) {
    if (!isset($context["APP_ENV"])) {
        throw new RuntimeException("Please provide \"APP_ENV\" environment variable.");
    }
    $_SERVER["APP_ENV"] = $_ENV["APP_ENV"] = $context["APP_ENV"];
    $_SERVER["APP_DEBUG"] = $_SERVER["APP_DEBUG"] ?? $_ENV["APP_DEBUG"] ?? "prod" !== $context["APP_ENV"];
    $_SERVER["APP_DEBUG"] = $_ENV["APP_DEBUG"] = (int) $_SERVER["APP_DEBUG"] || ("prod" !== $context["APP_ENV"]);
    
    // Load index.php.original (the original Kernel factory) instead of index.php (our bootstrap)
    $indexFile = file_exists(__DIR__."/../public/index.php.original") 
        ? __DIR__."/../public/index.php.original" 
        : __DIR__."/../public/index.php";
    
    $runtime = require $indexFile;
    return $runtime($context);
};
EOF
# Verify autoload_runtime.php exists
RUN test -f vendor/autoload_runtime.php || (echo "ERROR: Failed to create autoload_runtime.php" && exit 1)

# Copy the rest of the app (vendor will persist since it's not in source)
COPY . .

# Verify vendor still exists after copy
RUN ls -la vendor/autoload_runtime.php || (echo "ERROR: vendor/autoload_runtime.php missing after COPY" && exit 1)

# Create necessary directories and set permissions
RUN mkdir -p var/cache var/log var/sessions \
    && chown -R www-data:www-data /var/www/html \
    && chmod -R 755 /var/www/html \
    && chmod -R 777 var/

# Configure Apache for Sylius
RUN echo '<Directory /var/www/html/public>' >> /etc/apache2/apache2.conf \
    && echo '    AllowOverride All' >> /etc/apache2/apache2.conf \
    && echo '    Require all granted' >> /etc/apache2/apache2.conf \
    && echo '</Directory>' >> /etc/apache2/apache2.conf

# Set document root
ENV APACHE_DOCUMENT_ROOT /var/www/html/public
RUN sed -ri -e 's!/var/www/html!${APACHE_DOCUMENT_ROOT}!g' /etc/apache2/sites-available/*.conf \
    && sed -ri -e 's!/var/www/!${APACHE_DOCUMENT_ROOT}!g' /etc/apache2/apache2.conf /etc/apache2/conf-available/*.conf

# Ensure .htaccess routing
RUN echo 'RewriteEngine On' > /var/www/html/public/.htaccess \
    && echo 'RewriteCond %{REQUEST_FILENAME} !-f' >> /var/www/html/public/.htaccess \
    && echo 'RewriteRule ^(.*)$ index.php [QSA,L]' >> /var/www/html/public/.htaccess

# Fix index.php to auto-execute when called via web (Symfony Runtime bootstrap)
# Create index.php.original with just the Kernel factory (no autoload_runtime.php require)
# since autoloader is already loaded by autoload_runtime.php
# Note: Kernel.php must be explicitly required since it's only in autoload-dev
RUN cat > /var/www/html/public/index.php.original << 'ORIGEOF'
<?php

declare(strict_types=1);

use App\Kernel;

// Autoloader is already loaded by autoload_runtime.php
// Explicitly require Kernel since it's only in autoload-dev and we're using --no-dev
require_once dirname(__DIR__).'/src/Kernel.php';

return static function (array $context) {
    return new Kernel($context['APP_ENV'], (bool) $context['APP_DEBUG']);
};
ORIGEOF

# Create the bootstrap index.php
RUN cat > /var/www/html/public/index.php << 'EOF'
<?php

declare(strict_types=1);

use Symfony\Component\HttpFoundation\Request;

// Load autoloader first
require_once dirname(__DIR__).'/vendor/autoload.php';

// Load the runtime function
$runtime = require dirname(__DIR__).'/vendor/autoload_runtime.php';

$appEnv = $_ENV['APP_ENV'] ?? $_SERVER['APP_ENV'] ?? 'prod';
$appDebug = (bool) ($_ENV['APP_DEBUG'] ?? $_SERVER['APP_DEBUG'] ?? '0');

// The runtime function loads index.php.original and returns the Kernel
$kernel = $runtime([
    'APP_ENV' => $appEnv,
    'APP_DEBUG' => $appDebug,
]);

// Handle the request
$request = Request::createFromGlobals();
$response = $kernel->handle($request);
$response->send();
$kernel->terminate($request, $response);
EOF

EXPOSE 80
CMD ["apache2-foreground"]


